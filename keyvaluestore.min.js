/*! KeyValueStore.js / The MIT License / (C) 2015 Retorillo */
var KeyValueStore=function(){function i(i){var u="keyvalue",f=function(){},o=this,r=null;Object.defineProperty(this,"database",{get:function(){return r}});this.delete=function(){var t=new n(this),u;return r.close(),u=indexedDB.deleteDatabase(i),u.onerror=function(n){t.execute({name:"error",args:[n.error]})},u.onsuccess=function(){t.execute({name:"success",args:[]})},t};this.open=function(){var f=new n(this),t=window.indexedDB.open(i,10);return t.onerror=function(n){f.execute({name:"error",args:[n.error]})},t.onsuccess=function(){r=t.result;f.execute({name:"success",args:[t.result]})},t.onupgradeneeded=function(){r=t.result;r.objectStoreNames.contains(u)&&r.deleteObjectStore(u);var n=r.createObjectStore(u,{keyPath:"key"});n.createIndex("value","value",{unique:!1})},f};this.read=function(){var t=arguments,s=t.length==1&&t[0]instanceof Array?t[0]:t;var i=new n(this),f=r.transaction(u,"readonly").objectStore(u),o=[];return o.toString=function(){var n=[];return this.forEach(function(t){n.push([t.key," : ",t.value,""].join(""))}),n.join(", ")},f.transaction.oncomplete=function(){i.execute({name:"success",args:[o]})},f.transaction.onerror=function(n){i.execute({name:"error",args:[n.error]})},f.transaction.onabort=function(){i.execute({name:"error",args:[e.error]})},s.forEach(function(n){var t=f.get(n);t.onsuccess=function(){var n=t.result;n&&(o.push(n),Object.defineProperty(o,n.key,{get:function(){return n.value}}))}}),i};this.readAllKeys=function(){var t=new n(this),i=r.transaction(u,"readonly").objectStore(u),o=[],f;return i.transaction.oncomplete=function(){t.execute({name:"success",args:[o]})},i.transaction.onerror=function(){t.execute({name:"error",args:[e.error]})},i.transaction.onabort=function(){t.execute({name:"error",args:[e.error]})},f=i.openCursor(),f.onsuccess=function(){var n=f.result;n&&(o.push(n.key),n.continue())},t};this.write=function(){var i=arguments,o=[],f,s,h;if(i.length>=2&&i.length%2==0&&t(i,function(n,t){return t%2==1||typeof n=="string"}))for(f=0;f<i.length;f+=2)o.push({key:i[f],value:i[f+1]});else if(i.length==1&&i[0]instanceof Array)o=i[0];else if(i.length>=2&&t(i,function(n){return n instanceof Array}))for(f=0;f<i.length;f++)o.push({key:i[f][0],value:i[f][1]});else o=i;return s=new n(this),h=r.transaction(u,"readwrite").objectStore(u),h.transaction.oncomplete=function(){s.execute({name:"success"})},h.transaction.onerror=function(){s.execute({name:"error",args:[e.error]})},h.transaction.onabort=function(n){s.execute({name:"error",args:[n.error]})},o.forEach(function(n){h.put({key:n.key,value:n.value})}),s}}function n(n){var t=[];this.readAllKeys=function(){return this.enqueue({fn:n.readAllKeys,args:arguments,async:!0}),this};this.read=function(){return this.enqueue({fn:n.read,args:arguments,async:!0}),this};this.write=function(){return this.enqueue({fn:n.write,args:arguments,async:!0}),this};this.action=function(n){return this.enqueue({name:"action",fn:n,args:[],async:!1}),this};this.success=function(n){return this.enqueue({condition:"success",fn:n,args:[],async:!1}),this};this.error=function(n){return this.enqueue({condition:"error",fn:n,args:[],async:!1}),this};this.enqueue=function(n){t.push(n)};this.dequeue=function(){return t.splice(0,1)[0]};this.execute=function(i){for(var s=i.name=="error",r,o,u,f,e;t.length>0;){if(r=this.dequeue(),r.async){if(!s)for(o=r.fn.apply(n,r.args),u=0;u<t.length;u++)o.enqueue(t[u]);return}f=!1;e=null;r.condition&&(f=r.condition!=i.name,e=i.args);f||r.fn.apply(n,e)}}}function t(n,t){for(var i=0;i<n.length;i++)if(!t.apply(n,[n[i]],i))return!1;return!0}return i}();